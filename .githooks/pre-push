#!/bin/bash

# Pre-push hook for React Native iMessage Prototype
# Runs tests before allowing push to remote

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Add common node paths to PATH
export PATH="/usr/local/bin:/opt/homebrew/bin:$PATH"

# Source nvm if available
[ -s "$HOME/.nvm/nvm.sh" ] && \. "$HOME/.nvm/nvm.sh"

# Ensure we're using the correct Node version
if command -v nvm >/dev/null 2>&1; then
    nvm use >/dev/null 2>&1 || true
fi

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo -e "${RED}[ERROR] npm is not available in PATH${NC}"
    exit 1
fi

# Install dependencies if node_modules doesn't exist
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}Installing dependencies...${NC}"
    npm install
fi

# Run tests
echo -e "${YELLOW}Running test suite...${NC}"
if ! npm test -- --bail --findRelatedTests 2>&1; then
    echo -e "${RED}[ERROR] Tests failed. Fix failing tests before pushing.${NC}"
    echo -e "${YELLOW}Run 'npm test' to see detailed results${NC}"
    exit 1
fi

echo -e "${GREEN}[SUCCESS] All pre-push checks passed${NC}"
exit 0
